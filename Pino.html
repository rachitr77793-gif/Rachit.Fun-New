<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rachit.Fun â€” Piano (Final Best)</title>
<style>
  :root{--card:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f7fbff;color:#071133}
  /* TASKBAR (unchanged) */
  .topbar{ display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:transparent; border-bottom:1px solid rgba(0,0,0,0.03); position:sticky; top:0; z-index:50; }
  .left { display:flex; align-items:center; gap:12px; font-weight:800; }
  .left .logo{font-size:20px}
  .left .site{font-size:20px}
  .right { display:flex; align-items:center; gap:10px; }
  .color-picker{ width:36px; height:28px; border-radius:8px; border:1px solid #ccc; padding:0; }
  .btn{ background:var(--card); border:1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }

  /* page layout */
  .wrap{max-width:1100px;margin:18px auto;padding:12px;display:flex;flex-direction:column;align-items:center;gap:12px}
  h1{margin:6px 0 0 0;font-size:28px;font-weight:900}

  /* controls under the taskbar */
  .controls{
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:center;
    width:100%;
    max-width:980px;
  }
  .control-left{display:flex;gap:10px;align-items:center}
  .control-right{display:flex;gap:10px;align-items:center}
  .action{padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-weight:800;cursor:pointer}
  .action.primary{background:linear-gradient(90deg,#0ea5a3,#06b6b4);color:#fff;border:none}
  .select{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);font-weight:800;background:#fff}

  /* piano area */
  .piano-wrap{width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .keyboard{
    width:100%;
    max-width:920px;
    height:260px;
    display:grid;
    grid-template-columns: repeat(28, 1fr);
    gap:0;
    position:relative;
    user-select:none;
    touch-action:none;
  }

  .key.white{
    grid-column: span 2;
    background: linear-gradient(#fff,#fbfbfb);
    border:1px solid rgba(7,16,34,0.06);
    border-radius:6px;
    box-shadow: 0 6px 18px rgba(9,25,51,0.04);
    display:flex;align-items:flex-end;justify-content:center;padding-bottom:10px;font-weight:800;
    font-size:12px;color:#071133;position:relative;z-index:1;cursor:pointer;transition:transform .06s;
  }
  .key.white.active{transform:translateY(6px);box-shadow:none;background:linear-gradient(#f0f9ff,#e6f7ff)}
  .white-label{font-size:11px;opacity:0.6}

  .key.black{
    width:calc(100% * (2/28) * 0.6);
    height:62%;
    background:linear-gradient(#111,#0a0a0a);
    border-radius:6px;
    box-shadow:0 8px 20px rgba(9,25,51,0.12);
    position:relative;
    z-index:2;
    margin-left:-calc(100% * (2/28) * 0.3);
    margin-right:-calc(100% * (2/28) * 0.3);
    display:flex;align-items:flex-end;justify-content:center;padding-bottom:6px;color:#fff;font-weight:900;cursor:pointer;transition:transform .06s;
  }
  .key.black.active{transform:translateY(6px);box-shadow:none;background:linear-gradient(#2b2b2b,#151515)}

  .legend{font-size:12px;color:#334155;margin-top:6px;font-weight:700}

  @media (max-width:900px){
    .keyboard{height:200px}
    .key.white{font-size:11px}
    .key.black{height:60%}
  }
  @media (max-width:480px){
    .keyboard{height:160px}
  }
</style>
</head>
<body>

<!-- taskbar (unchanged) -->
<header class="topbar">
  <div class="left">
    <div class="logo">ðŸŽ®</div>
    <div class="site">Rachit.Fun</div>
  </div>
  <div class="right">
    <label style="display:flex;align-items:center;gap:8px;font-weight:700">
      BG
      <input id="bgPicker" class="color-picker" type="color" value="#f7fbff" />
    </label>
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="resetAllBtn">Reset All</button>
  </div>
</header>

<div class="wrap">
  <h1>ðŸŽ¹ Piano â€” Pro (Final)</h1>

  <!-- controls below taskbar (START + RESET + Mode) -->
  <div class="controls" role="toolbar" aria-label="piano controls">
    <div class="control-left">
      <button id="startBtn" class="action primary">Start</button>
      <button id="resetBtn" class="action">Reset</button>

      <label style="display:flex;align-items:center;gap:8px;font-weight:800">
        Mode
        <select id="modeSel" class="select">
          <option value="free">Free Play</option>
          <option value="auto">Auto Music</option>
        </select>
      </label>
    </div>

    <div class="control-right">
      <div class="legend">Play by clicking / touching keys â€” or use keyboard</div>
    </div>
  </div>

  <!-- piano keyboard -->
  <div class="piano-wrap">
    <div id="keyboard" class="keyboard" aria-label="virtual piano"></div>
    <div class="legend">Keyboard mapping: lower row = Z X C V B N , . /  â€” upper row = A S D F G H J K L ; Q 2 W</div>
  </div>
</div>

<script>
/* ---------- Persist BG (exact) ---------- */
const BG_KEY = 'rachit_bg';
const bgPicker = document.getElementById('bgPicker');
const savedBG = localStorage.getItem(BG_KEY);
if (savedBG) { document.body.style.background = savedBG; bgPicker.value = savedBG; }
bgPicker.addEventListener('input', e => { document.body.style.background = e.target.value; localStorage.setItem(BG_KEY, e.target.value); });
document.getElementById('homeBtn').addEventListener('click', () => { window.location.href = 'index.html'; });
document.getElementById('resetAllBtn').addEventListener('click', () => { if (!confirm('Reset everything? This clears BG setting.')) return; localStorage.removeItem(BG_KEY); location.reload(); });

/* ---------- Audio (fixed clean envelopes, no echo) ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

/* NOTES (C4..B5) â€” C6 removed */
const NOTES = [
  { name: 'C4',  freq: 261.6256 }, { name: 'C#4', freq: 277.1826 },
  { name: 'D4',  freq: 293.6648 }, { name: 'D#4', freq: 311.1270 },
  { name: 'E4',  freq: 329.6276 }, { name: 'F4',  freq: 349.2282 },
  { name: 'F#4', freq: 369.9944 }, { name: 'G4',  freq: 392.0000 },
  { name: 'G#4', freq: 415.3047 }, { name: 'A4',  freq: 440.0000 },
  { name: 'A#4', freq: 466.1638 }, { name: 'B4',  freq: 493.8833 },

  { name: 'C5',  freq: 523.2511 }, { name: 'C#5', freq: 554.3653 },
  { name: 'D5',  freq: 587.3295 }, { name: 'D#5', freq: 622.2540 },
  { name: 'E5',  freq: 659.2551 }, { name: 'F5',  freq: 698.4565 },
  { name: 'F#5', freq: 739.9888 }, { name: 'G5',  freq: 783.9909 },
  { name: 'G#5', freq: 830.6094 }, { name: 'A5',  freq: 880.0000 },
  { name: 'A#5', freq: 932.3275 }, { name: 'B5',  freq: 987.7666 }
];

/* Build visual keys */
const keyboard = document.getElementById('keyboard');
function isSharp(n){ return n.includes('#'); }

const visualKeys = [];
NOTES.forEach((n, idx) => {
  const type = isSharp(n.name) ? 'black' : 'white';
  visualKeys.push({ id: idx, name: n.name, freq: n.freq, type, keyChar: null, el: null });
});

/* Render keys: whites then blacks for proper overlap */
function renderKeys(){
  keyboard.innerHTML = '';
  visualKeys.forEach(k => {
    if(k.type === 'white'){
      const el = document.createElement('div');
      el.className = 'key white';
      el.dataset.id = k.id;
      el.dataset.name = k.name;
      el.innerHTML = `<div class="white-label">${k.name}</div>`;
      keyboard.appendChild(el);
      k.el = el;
    }
  });
  visualKeys.forEach(k => {
    if(k.type === 'black'){
      const el = document.createElement('div');
      el.className = 'key black';
      el.dataset.id = k.id;
      el.dataset.name = k.name;
      el.innerHTML = `<div style="font-size:11px;opacity:0.9">${k.name}</div>`;
      keyboard.appendChild(el);
      k.el = el;
    }
  });
}
renderKeys();

/* Clean warm note with envelope (no echo) */
function playNoteClean(freq){
  const now = audioCtx.currentTime;
  const oscA = audioCtx.createOscillator();
  const oscB = audioCtx.createOscillator();
  const sub = audioCtx.createOscillator();

  const g = audioCtx.createGain();
  const gSub = audioCtx.createGain();

  // timbre
  oscA.type = 'sine';
  oscB.type = 'triangle';
  sub.type = 'sine';

  // freq
  oscA.frequency.setValueAtTime(freq, now);
  oscB.frequency.setValueAtTime(freq * 1.0015, now);
  sub.frequency.setValueAtTime(freq * 0.5, now);

  // envelope for main gain
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.95, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now + 0.9);

  // sub low level
  gSub.gain.setValueAtTime(0.06, now);

  // routing
  oscA.connect(g);
  oscB.connect(g);
  sub.connect(gSub);

  const master = audioCtx.createGain();
  master.gain.setValueAtTime(0.9, now);
  g.connect(master);
  gSub.connect(master);
  master.connect(audioCtx.destination);

  // start/stop cleanly
  oscA.start(now);
  oscB.start(now);
  sub.start(now);
  oscA.stop(now + 1.0);
  oscB.stop(now + 1.0);
  sub.stop(now + 1.0);

  // ensure disconnect after stop to avoid echoes
  setTimeout(()=>{
    try{ oscA.disconnect(); oscB.disconnect(); sub.disconnect(); g.disconnect(); gSub.disconnect(); master.disconnect(); }catch(e){}
  }, 1100);
}

/* Visual press */
function pressVisual(k){
  if(!k || !k.el) return;
  k.el.classList.add('active');
  setTimeout(()=>k.el.classList.remove('active'), 150);
}

/* Play by visual key id */
function playById(id){
  const k = visualKeys[id];
  if(!k) return;
  playNoteClean(k.freq);
  pressVisual(k);
}

/* Pointer interactions */
keyboard.addEventListener('pointerdown', (e)=>{
  const el = e.target.closest('.key');
  if(!el) return;
  const id = Number(el.dataset.id);
  playById(id);
});
keyboard.addEventListener('pointermove', (e)=>{
  if(!e.buttons) return;
  const el = e.target.closest('.key');
  if(!el) return;
  const id = Number(el.dataset.id);
  playById(id);
});

/* --------- KEYBOARD MAPPING: OPTION A (24 mappings) ----------
Lower row: z x c v b n , . /
Upper row: a s d f g h j k l ; q 2 w 3 e
(This supplies 24 different physical keys to cover the 24 displayed notes)
*/
const keyMap = ['z','x','c','v','b','n',',','.','/','a','s','d','f','g','h','j','k','l',';','q','2','w','3','e'];
// if keyMap length differs from NOTES length, clip or pad
for(let i=0;i<visualKeys.length;i++){
  visualKeys[i].keyChar = keyMap[i] || null;
}

/* Keydown listener */
window.addEventListener('keydown', (ev)=>{
  const k = ev.key.toLowerCase();
  // find mapped key
  const vk = visualKeys.find(v=> v.keyChar === k);
  if(vk){
    ev.preventDefault();
    playById(vk.id);
  }
  // space toggles start/stop of auto if in auto mode
  if(ev.code === 'Space'){
    ev.preventDefault();
    if(modeSel.value === 'auto'){
      if(startBtn.disabled) { stopAuto(); } else { startAuto(); }
    }
  }
});

/* ---------- Auto-Music (musical warm melody) ---------- */
const MELODY = [
  // C major arpeggio up
  { id: 0, d: 1 },  // C4
  { id: 4, d: 1 },  // E4
  { id: 7, d: 1 },  // G4
  { id: 12, d: 1 }, // C5

  // gentle descent
  { id: 11, d: 1 }, // B4
  { id: 9, d: 1 },  // A4
  { id: 7, d: 1 },  // G4
  { id: 4, d: 1 },  // E4

  // pretty phrase
  { id: 5, d: 1 },  // F4
  { id: 9, d: 1 },  // A4
  { id: 14, d: 1 }, // D5
  { id: 16, d: 1 }, // F5
  { id: 19, d: 1 }, // G5

  // closing fall & hold
  { id: 16, d: 1 }, // F5
  { id: 14, d: 1 }, // D5
  { id: 12, d: 2 }  // C5 (hold)
];

let autoTimer = null, autoIdx = 0, autoPlaying = false;
function startAuto(){
  if(autoPlaying) return;
  autoPlaying = true;
  autoIdx = 0;
  function step(){
    if(!autoPlaying) return;
    const note = MELODY[autoIdx % MELODY.length];
    playById(note.id);
    autoIdx++;
    autoTimer = setTimeout(step, 360 * note.d); // warm tempo
  }
  step();
  startBtn.disabled = true;
}
function stopAuto(){
  autoPlaying = false;
  clearTimeout(autoTimer);
  autoTimer = null;
  startBtn.disabled = false;
}

/* UI wiring */
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const modeSel = document.getElementById('modeSel');

startBtn.addEventListener('click', ()=>{
  if(audioCtx.state === 'suspended') audioCtx.resume();
  if(modeSel.value === 'auto') startAuto();
  else {
    // free play start: visually disable then re-enable quickly (keeps consistent UX)
    startBtn.disabled = true;
    setTimeout(()=> startBtn.disabled = false, 140);
  }
});
resetBtn.addEventListener('click', ()=>{
  stopAuto();
  visualKeys.forEach(k=> k.el.classList.remove('active'));
});

/* When mode switches, start/stop accordingly */
modeSel.addEventListener('change', ()=>{
  if(modeSel.value === 'auto') startAuto(); else stopAuto();
});

/* Ensure audio context resumes on first interaction */
function resumeAudio() { if(audioCtx.state === 'suspended') audioCtx.resume(); window.removeEventListener('pointerdown', resumeAudio); window.removeEventListener('keydown', resumeAudio); }
window.addEventListener('pointerdown', resumeAudio);
window.addEventListener('keydown', resumeAudio);

</script>
</body>
</html>


